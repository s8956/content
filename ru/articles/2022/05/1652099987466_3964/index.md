---
# -------------------------------------------------------------------------------------------------------------------- #
# General settings.
# -------------------------------------------------------------------------------------------------------------------- #

title: 'Интеграция обновлений в дистрибутив ОС MS Windows'
description: ''
images:
  - 'https://images.unsplash.com/photo-1620843002805-05a08cb72f57'
categories:
  - 'windows'
  - 'terminal'
  - 'scripts'
tags:
  - 'cmd'
  - 'adk'
  - 'dism'
  - 'интеграция'
authors:
  - 'KaiKimera'
license: 'CC-BY-SA-4.0'
complexity: '1'
toc: 1
comments: 1

# -------------------------------------------------------------------------------------------------------------------- #
# Date settings.
# -------------------------------------------------------------------------------------------------------------------- #

date: '2022-05-09T15:39:47+03:00'

# -------------------------------------------------------------------------------------------------------------------- #
# Meta settings.
# -------------------------------------------------------------------------------------------------------------------- #

type: 'articles'
hash: '862226e6cbb178f89c8e0cfef747f475ef4ff24b'
uuid: '862226e6-cbb1-58f8-bc8e-0cfef747f475'
slug: '862226e6-cbb1-58f8-bc8e-0cfef747f475'

draft: 0
---

Microsoft каждый месяц выпускает новые версии дистрибутивов с уже интегрированными обновлениями. Но есть редакции ОС, например {{< tag "LTSC" >}}, для которых Microsoft не выполняет подобные действия. Приходится делать самому...

<!--more-->

## Подготовка

Для интеграции обновлений в дистрибутив ОС, потребуется:

- Дистрибутив операционной системы в файле `.iso`.
- Доступ в интернет для скачивания необходимых инструментов и обновлений.
- Рекомендуется {{< tag "SSD" >}}. Все ниже приведённые этапы требуют активной работы с файлами. Поэтому, существенное ускорение можно получить выполняя все задачи на {{< tag "SSD" >}}.

### Структура директорий

Для начала необходимо создать структуру директорий, которая послужит базисом для процесса интеграции обновлений:

- `C:\BuildFarm` - корневая директория для работы.
  - `\MNT` - директория, в которую будет монтироваться образ WIM.
  - `\UPD` - директория для хранения скаченных обновлений.
  - `\WIM` - директория для хранения образа WIM.

### MS DISM

Для интеграции обновлений потребуется инструмент **Deployment Image Servicing and Management (DISM)** (`DISM.exe`), который входит в комплект [Windows Assessment and Deployment Kit (Windows ADK)](https://learn.microsoft.com/en-us/windows-hardware/get-started/adk-install). Обычно, DISM уже поставляется с операционной системой, но я рекомендую [скачивать](https://learn.microsoft.com/en-us/windows-hardware/get-started/adk-install#other-adk-downloads) последнюю версию с сайта Microsoft и устанавливать вручную.

Когда Windows ADK установлен, {{< tag "DISM" >}} можно найти в меню **"Пуск"** вместе с остальными программам. Запускать {{< tag "DISM" >}} необходимо под администратором. Все команды, приведённые ниже, должны будут выполняться только через установленный вручную {{< tag "DISM" >}}. Использовать {{< tag "DISM" >}}, поставляемый с операционной системой нет необходимости.

{{< alert "tip" >}}
Установленный вручную {{< tag "DISM" >}} можно найти в меню "Пуск" / Windows Kits / **Среда средств развертывания и работы с образами**.
{{< /alert >}}

## Интеграция обновлений

Обновления можно скачивать с сайта-каталога [Microsoft Update Catalog](https://www.catalog.update.microsoft.com/). Я беру так называемые "кумулятивные (накопительные) обновления" (cumulative updates), содержащие в себе сразу множество пакетов с исправлениями и обновлениями функций. [Найти](https://www.catalog.update.microsoft.com/Search.aspx?q=cumulative%20update) такие крупные обновления можно в каталоге при помощи поискового запроса `cumulative update`.

Скачиваемые обновления помещаются в директорию `C:\BuildFarm\UPD` для дальнейшей интеграции в дистрибутив ОС.

### Извлечение файла WIM из дистрибутива MS Windows

Образ ОС находится в специальном файле `sources\install.wim`. Его необходимо извлечь при помощи программ для работы с файлами `.iso` (подойдёт [UltraISO](https://www.ultraiso.com) или [PowerISO](https://www.poweriso.com)) в директорию `C:\BuildFarm\WIM`.

### Получение информации из WIM-образа

Файл `install.wim` может содержать несколько редакций ОС. Каждая редакция ОС имеет свой индекс. Для того, чтобы увидеть эти индексы, нужно ввести команду:

```powershell
Dism /Get-ImageInfo /ImageFile:"C:\BuildFarm\WIM\install.wim"
```

Где:

- `/Get-ImageInfo` - получить информацию о версиях операционной системы, находящихся в WIM-образ.
- `/ImageFile` - путь к WIM-образу.

Введённая команда предоставит примерно такой выхлоп:

{{< terminal os="windows" mode="root" >}}
Dism /Get-ImageInfo /ImageFile:"C:\BuildFarm\WIM\install.wim"

Details for image : C:\BuildFarm\WIM\install.wim

Index : 1
Name : Windows 10 Education
Description : Windows 10 Education
Size : 15,643,499,526 bytes

Index : 2
Name : Windows 10 Education N
Description : Windows 10 Education N
Size : 14,878,972,660 bytes

Index : 3
Name : Windows 10 Enterprise
Description : Windows 10 Enterprise
Size : 15,643,653,521 bytes

Index : 4
Name : Windows 10 Enterprise N
Description : Windows 10 Enterprise N
Size : 14,878,878,937 bytes

Index : 5
Name : Windows 10 Pro
Description : Windows 10 Pro
Size : 15,658,943,281 bytes

<...>
Extract Specific Windows Index from Windows 10 Multiple Edition ISO
{{< /terminal >}}

### Монтирование WIM-образа

Индексы получены. Теперь необходимо примонтировать редакцию ОС из конкретного индекса. Выбор индекса зависит от вас: выбираете индекс той редакции ОС, которая вам необходима. Я выбрал редакцию **Windows 10 Pro** с индексом `5`:

```powershell
Dism /Mount-Image /ImageFile:"C:\BuildFarm\WIM\install.wim" /MountDir:"C:\BuildFarm\MNT" /index:5
```

Где:

- `/Mount-Image` - команда на монтирование {{< tag "WIM" >}}-образа.
- `/MountDir` - путь к директории, в которую необходимо поместить содержимое монтируемого {{< tag "WIM" >}}-образа.
- `/index:5` - номер версии дистрибутива ОС. Номер можно узнать командой `/Get-ImageInfo`.

{{< alert "tip" >}}
Если что-то пошло не так, размонтировать образ без сохранения можно следующей командой:

```bat
Dism /Unmount-Image /MountDir:"C:\BuildFarm\MNT" /Discard
```

Проверить список примонтированных образов можно следующей командой:

```bat
Dism /Get-MountedImageInfo
```

Если после размонтирования образ всё ещё остаётся подключённым к системе и является повреждённым, следующая команда можешь помочь:

```bat
Dism /Cleanup-Mountpoints
```

Она удалит все ресурсы, связанные с повреждённым образом и очистит систему от "зависших" точек монтирования.
{{< /alert >}}

### Интеграция обновлений в WIM-образ

После монтирования редакции ОС с конкретным индексом, можно начинать процесс интеграции обновлений:

```powershell
Dism /Image:"C:\BuildFarm\MNT" /Add-Package /PackagePath:"C:\BuildFarm\UPD"
```
Где:

- `/Image` - путь к директории, в которой находится содержимое примонтированного WIM-образа.
- `/Add-Package` - команда на добавление пакетов (обновлений) в WIM-образ.
  - `/PackagePath` - путь к директории, в которой находятся пакеты (обновления) для интеграции в WIM-образ.

### Проверка корректности интеграции обновлений (опционально)

По окончании процесса интеграции, можно проверить корректность выполненной задачи. Команда ниже покажет список пакетов, установленных в примонтированной редакции ОС. В этом списке пакетов будут интегрированные обновления.

```powershell
Dism /Image:"C:\BuildFarm\MNT" /Get-Packages
```
Где:

- `/Image` - путь к директории, в которой находится содержимое примонтированного {{< tag "WIM" >}}-образа.
- `/Get-Packages` - команда для получения информации о интегрированных пакетах примонтированного {{< tag "WIM" >}}-образа.

### Очистка хранилища компонентов WIM-образ (опционально)

Для уменьшения размера дистрибутива можно запустить процедуру удаления предыдущих версий компонентов, которые были изменены (заменены) установленными обновлениями:

```powershell
Dism /Image:"C:\BuildFarm\MNT" /Cleanup-Image /StartComponentCleanup /ResetBase
```

Где:

- `/Image` - путь к директории, в которой находится содержимое примонтированного {{< tag "WIM" >}}-образа.
- `/Cleanup-Image` - очистка и восстановление образа.
  - `/StartComponentCleanup` - удаляет заменённые компоненты и уменьшает размер хранилища компонентов.
    - `/ResetBase` - сброс базы заменяемых компонентов.

### Проверка хранилища компонентов WIM-образа (опционально)

Опциональный шаг перед заключительным этапом - проверить системные компоненты и файлы на повреждения:

```powershell
Dism /Image:"C:\BuildFarm\MNT" /Cleanup-Image /ScanHealth
```

Где:

- `/Image` - путь к директории, в которой находится содержимое примонтированного {{< tag "WIM" >}}-образа.
- `/Cleanup-Image` - очистка и восстановление образа.
  - `/ScanHealth` - сканирование образа на наличие повреждений хранилища компонентов.

### Сохранение изменений в WIM-образе

После выполнения всех действий, необходимо отмонтировать редакцию ОС с сохранением изменений. Делается это командой:

```powershell
Dism /Unmount-Image /MountDir:"C:\BuildFarm\MNT" /Commit
```

Где:

- `/Unmount-Image` - команда для отмонтирования {{< tag "WIM" >}}-образа.
- `/MountDir` - путь к директории, в которой находится содержимое примонтированного {{< tag "WIM" >}}-образа.
- `/Commit` - сохранение совершённых изменений в {{< tag "WIM" >}}-образе.

Всё. Мы получили файл `install.wim` с интегрированными обновлениями. Теперь этот файл `install.wim` необходимо обратно упаковать в образ {{< tag "ISO" >}} с заменой старого.

## Автоматизация

Я люблю автоматизировать всё по максимуму. И здесь я не упустил шанс написать небольшой скрипт с деревянной логикой, который сделает все шаги по интеграции обновлений за человека. Только вот, извлечь файл `install.wim` из {{< tag "ISO" >}}-образа придётся самому.

{{< file "dism.packages.bat" >}}

Поместить скрипт нужно в корень директории `BuildFarm` и запустить из терминала {{< tag "DISM" >}}. Если же возникнут какие-либо проблемы, ниже есть небольшой скрипт, который размонтирует образ и очистит систему от точек монтирования.

{{< file "dism.unmount.bat" >}}
