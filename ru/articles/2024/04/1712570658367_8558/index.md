---
# -------------------------------------------------------------------------------------------------------------------- #
# GENERAL
# -------------------------------------------------------------------------------------------------------------------- #

title: 'MikroTik: Туннель GRE/IPsec (Site-to-Site)'
description: ''
images:
  - 'https://images.unsplash.com/photo-1486881809698-a59614a9ac7e'
categories:
  - 'network'
  - 'scripts'
tags:
  - 'mikrotik'
  - 'routeros'
  - 'gre'
  - 'ipsec'
authors:
  - 'KaiKimera'
sources:
  - ''
license: 'CC-BY-SA-4.0'
complexity: '1'
toc: 1
comments: 1

# -------------------------------------------------------------------------------------------------------------------- #
# DATE
# -------------------------------------------------------------------------------------------------------------------- #

date: '2024-04-08T13:04:21+03:00'
publishDate: '2024-04-08T13:04:21+03:00'
lastMod: '2024-04-08T13:04:21+03:00'

# -------------------------------------------------------------------------------------------------------------------- #
# META
# -------------------------------------------------------------------------------------------------------------------- #

type: 'articles'
hash: '326618afd9501001d11457c66bb8a5af77df3198'
uuid: '326618af-d950-5001-8114-57c66bb8a5af'
slug: '326618af-d950-5001-8114-57c66bb8a5af'

draft: 0
---

Продолжаем серию статей по настройке туннеля между двумя маршрутизаторами. На этот раз создадим {{< tag "GRE" >}} туннель.

<!--more-->

На обоих маршрутизаторах у меня используются динамические WAN IP. {{< tag "GRE" >}} предпочитает только статические IP-адреса. Чтобы обойти данное ограничение, я использую скрипт из статьи {{< uuid "ff2ae66e-8e14-5c4a-baa6-0cd2e59f6517" >}}, который обновляет IP-адреса маршрутизаторов в суб-доменах, далее скриптом в конце статьи я забираю актуальные IP-адреса суб-доменов и обновляю их в настройках интерфейса {{< tag "GRE" >}}.

## Исходные данные

- Маршрутизатор `R1`:
  - WAN IP: `gw1.example.com`.
  - LAN IP: `10.1.0.1`.
  - Network: `10.1.0.0/16`.
- Маршрутизатор `R2`:
  - WAN IP: `gw2.example.com`.
  - LAN IP: `10.2.0.1`.
  - Network: `10.2.0.0/16`.

## Настройка маршрутизаторов

{{< alert "info" >}}
В моём случае, первоначальные адреса WAN IP маршрутизаторов не имею значения. Они всё равно будут обновлены скриптом на актуальные, взятые у суб-доменов.
{{< /alert >}}

### Router #1

- Создаём интерфейс {{< tag "GRE">}}:
  - Имя интерфейса: `gre-sts`.
  - Секретная фраза для IPsec: `PassWord`.
  - WAN IP-адрес локального маршрутизатора `R1`: `1.1.1.1`.
  - WAN IP-адрес удалённого маршрутизатора `R2`: `2.2.2.2`.
  - Комментарий: `HOST: gw2.example.com`.

```text
/interface gre
add allow-fast-path=no ipsec-secret="PassWord" name="gre-sts" remote-address=2.2.2.2 comment="HOST: gw2.example.com"
```

- Прописываем интерфейсу IP-адрес `10.255.255.1/24`:
  - Адрес интерфейса: `10.255.255.1/24`.
  - Интерфейс: `gre-sts`.
  - Комментарий: `[GRE] GRE-STS`.

```text
/ip address
add address=10.255.255.1/24 interface="gre-sts" comment="[GRE] GRE-STS"
```

- Указываем маршрут до удалённой сети `R2`:
  - Адрес удалённой сети `R2`: `10.2.0.0/16`.
  - Шлюз `R2`: `10.255.255.2`.
  - Комментарий: `[GRE] GW2`.

```text
/ip route
add distance=1 dst-address=10.2.0.0/16 gateway=10.255.255.2 comment="[GRE] GW2"
```

### Router #2

- Создаём интерфейс {{< tag "GRE">}}:
  - Имя интерфейса: `gre-sts`.
  - Секретная фраза для IPsec: `PassWord`.
  - WAN IP-адрес локального маршрутизатора `R2`: `2.2.2.2`.
  - WAN IP-адрес удалённого маршрутизатора `R1`: `1.1.1.1`.
  - Комментарий: `HOST: gw1.example.com`.

```text
/interface gre
add allow-fast-path=no ipsec-secret="PassWord" name="gre-sts" remote-address=1.1.1.1 comment="HOST: gw1.example.com"
```

- Прописываем интерфейсу IP-адрес `10.255.255.2/24`:
  - Адрес интерфейса: `10.255.255.2/24`.
  - Интерфейс: `gre-sts`.
  - Комментарий: `[GRE] GRE-STS`.

```text
/ip address
add address=10.255.255.2/24 interface="gre-sts" comment="[GRE] GRE-STS"
```

- Указываем маршрут до удалённой сети `R1`:
  - Адрес удалённой сети `R1`: `10.1.0.0/16`.
  - Шлюз `R1`: `10.255.255.1`.
  - Комментарий: `[GRE] GW1`.

```text
/ip route
add distance=1 dst-address=10.1.0.0/16 gateway=10.255.255.1 comment="[GRE] GW1"
```

## Скрипт для динамического IP

К сожалению, {{< tag "MikroTik" >}} для интерфейса {{< tag "GRE" >}} использует только IP-адреса, нельзя указать имя суб-домена. Но на форуме {{< tag "MikroTik" >}} я нашёл скрипт, который парсит доменное имя удалённого маршрутизатора в специально составленном комментарии (`HOST: sub.example.com`) к интерфейсу и запрашивает IP-адрес этого домена. Этот IP-адрес автоматически вставляется в поле `remote-address` интерфейса {{< tag "GRE" >}}.

### Приложение

{{< file "ros.gre.ip.rsc" >}}

#### Параметры

- `wanInterface` - название WAN-интерфейса.

### Установка

После настройки скрипта, его нужно добавить в репозиторий скриптов {{< tag "RouterOS" >}}. Находится репозиторий в System / Scripts. При добавлении скрипта, необходимо выбрать политики `read`, `write`, `test`.

### Планировщик

Скрипт должен переодически запускаться для проверки и синхронизации IP адресов интерфейсов и домена. В этом поможет планировщик {{< tag "RouterOS" >}}. Заходим в System / Scheduler и создаём задачу с политиками `read`, `write`, `test`. В поле **On Event** вписываем точное название скрипта, ранее добавленного в репозиторий {{< tag "RouterOS" >}}.
