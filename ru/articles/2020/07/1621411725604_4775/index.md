---
# -------------------------------------------------------------------------------------------------------------------- #
# GENERAL
# -------------------------------------------------------------------------------------------------------------------- #

title: 'MikroTik и CloudFlare: Динамический IP для домена'
description: ''
images:
  - 'https://images.unsplash.com/photo-1521542464131-cb30f7398bc6'
cover:
  crop: 'bottom'
categories:
  - 'network'
  - 'scripts'
tags:
  - 'router'
  - 'mikrotik'
  - 'routeros'
  - 'cloudflare'
authors:
  - 'KaiKimera'
license: 'CC-BY-SA-4.0'
complexity: '1'
toc: 1
comments: 1

# -------------------------------------------------------------------------------------------------------------------- #
# DATE
# -------------------------------------------------------------------------------------------------------------------- #

date: '2020-07-12T18:09:48+03:00'
publishDate: '2020-07-12T18:09:48+03:00'
lastMod: '2023-10-19T04:49:00+03:00'

# -------------------------------------------------------------------------------------------------------------------- #
# META
# -------------------------------------------------------------------------------------------------------------------- #

type: 'articles'
hash: 'ff2ae66e8e14dc4a5aa60cd2e59f6517c64426b0'
uuid: 'ff2ae66e-8e14-5c4a-baa6-0cd2e59f6517'
slug: 'ff2ae66e-8e14-5c4a-baa6-0cd2e59f6517'

draft: 0
---

Нашёл скрипт реализации динамической смены IP адреса из {{< tag "RouterOS" >}} напрямую в панели управления {{< tag "CloudFlare" >}} при помощи {{< tag "API" >}}. Где нашёл скрипт уже не помню, вроде бы на страницах официального форума {{< tag "MikroTik" >}}.

<!--more-->

Скрипт я немного переделал, удалил лишние переменные, некоторые переопределил, подправил области видимости переменных, обновил метод авторизации скрипта на серверах {{< tag "CloudFlare" >}}. Вроде работает.

Сам скрипт нужно настроить под себя, прописав в нём значения переменных. Некоторые значений можно узнать из панели управления доменом в {{< tag "CloudFlare" >}}, но для получения значения переменной `cfDnsID` необходимо выполнит немного телодвижений. Об этом ниже.

## Работа CloudFlare API

Без токена - никак.

### Создание токена

Для того, чтобы начать работать с {{< tag "CloudFlare" >}} {{< tag "API" >}}, нам нужно создать специальный токен:

1. Зайти в [панель управления токенами](https://dash.cloudflare.com/profile/api-tokens).
2. Нажать кнопку {{< key "Create Token" >}}.
3. На странице выбора шаблонов - выбрать шаблон **Edit zone DNS**.
4. В разделе **Zone Resources** можно выбрать область доступа токена к зонам (доменам). Можно указать конкретную зону (*Specific zone*) или выбрать все зоны (*All zones*).
5. Всё, нажимаем кнопку {{< key "Continue to summary" >}} и перемещаемся на следующую станицу...

### Проверка токена

По окончании создания токена, {{< tag "CloudFlare" >}} переместит нас на страницу проверки токена. На этой странице будут наш созданный токен (его необходимо сохранить) и команда, которой при помощи утилиты `curl` можно проверить корректность токена:

```bash
curl -X GET "https://api.cloudflare.com/client/v4/user/tokens/verify" \
-H "Authorization: Bearer TOKEN" \
-H "Content-Type:application/json" | python3 -mjson.tool
```

При выполнении, команда вернёт следующий результат:

```terminal
curl -X GET "https://api.cloudflare.com/client/v4/user/tokens/verify" -H "Authorization: Bearer <...>" -H "Content-Type: application/json" | python3 -mjson.tool

{
    "result": {
        "id": "<...>",
        "status": "active"
    },
    "success": true,
    "errors": [],
    "messages": [
        {
            "code": 10000,
            "message": "This API Token is valid and active",
            "type": null
        }
    ]
}
```

По сообщению "This API Token is valid and active" понятно, что токен корректный и работает.

### Получение ID ресурсной записи домена

Когда у нас есть токен, можно полноценно работать с {{< tag "CloudFlare" >}} {{< tag "API" >}}. Нам нужно получить ID ресурсной записи домена. Получать будем следующей командой:

```bash
curl -X GET "https://api.cloudflare.com/client/v4/zones/ZONE_ID/dns_records" \
-H "Authorization: Bearer TOKEN" \
-H "Content-Type: application/json" | python3 -mjson.tool
```

Обратите внимание на следующие заглушки в команде:

- `ZONE_ID` - ID домена. Находится в панели оправления доменом на главной странице в поле **Zone ID**.
- `TOKEN` - токен для доступа к {{< tag "CloudFlare" >}} {{< tag "API" >}}.

{{< alert "important" >}}
Вместо этих заглушек необходимо подставить свои значения.
{{< /alert >}}

Сформировав правильную команду с корректными данными и выполнив её, команда вернёт результат в формате {{< tag "JSON" >}}. Результат будет содержать набор всех ресурсных записей конкретного домена. У меня это выглядит так:

```terminal
curl -X GET "https://api.cloudflare.com/client/v4/zones/<...>/dns_records" -H "Authorization: Bearer <...>" -H "Content-Type: application/json" | python3 -mjson.tool

{
    "result": [
        {
            "id": "gJDSG5la4IWNOEVn6K2PHyope8Q9YhzC",
            "zone_id": "<...>",
            "zone_name": "example.org",
            "name": "example.org",
            "type": "A",
            "content": "192.168.10.232",
            "proxiable": true,
            "proxied": true,
            "ttl": 1,
            "locked": false,
            "meta": {
                "auto_added": false,
                "managed_by_apps": false,
                "managed_by_argo_tunnel": false,
                "source": "primary"
            },
            "created_on": "2020-02-23T21:26:27.56227Z",
            "modified_on": "2020-02-23T21:26:27.56227Z"
        }
    ],
    "success": true,
    "errors": [],
    "messages": [],
    "result_info": {
        "page": 1,
        "per_page": 20,
        "count": 7,
        "total_count": 7,
        "total_pages": 1
    }
}
```

Как видим, команда вернула нам результат с массивом `result`. В этом массиве находятся все ресурсные записи нашего домена. Каждая ресурсная запись содержит поля `id` и `content`:

- `id` - ID ресурсной записи. Очень важное поле, как раз его значение необходимо записать в переменную `cfDnsID` скрипта.
- `content` - содержимое ресурсной записи.

Нам необходимы только записи с типом `A`. Обычно в записях с типом `A` хранятся IP адреса серверов, к которым привязан домен. У записей с типом `A` в поле `content` находится IP адрес, который должен изменить наш {{< tag "MikroTik" >}} при обращении к {{< tag "CloudFlare" >}} {{< tag "API" >}}.

## Скрипт

Скрипт забирает внешний IP-адрес роутера и присваивает его указанному домену в CloudFlare.

### Приложение

{{< file "ros.dns.rsc" >}}

#### Параметры

- `rosWanInterface` - имя интерфейса **WAN** в {{< tag "RouterOS" >}}.
- `rosCheckCrt` - включение / отключение проверки цепочки сертификации при запросе к {{< tag "CloudFlare" >}} {{< tag "API" >}}. Для корректной работы этой функции необходимо, чтобы в репозитории сертификатов {{< tag "RouterOS" >}} присутствовали корневые сертификаты центров сертификации. Про импортирование сертификатов написано в заметке {{< uuid "cc13623b-970c-5950-867e-168f9ba9025a" >}}.
- `cfToken` - токен, полученный в [панели управления токенами](https://dash.cloudflare.com/profile/api-tokens).
- `cfDomain` - название домена, для которого необходимо динамически менять IP адрес.
- `cfZoneID` - ID домена. Находится в панели управления доменом на главной странице в поле **Zone ID**.
- `cfDnsID` - ID ресурсной записи домена. Для получения значения переменной, необходимо выполнить запрос к {{< tag "CloudFlare" >}} {{< tag "API" >}}.
- `cfRecordType` - тип ресурсной записи домена. Обычно это `A`. Менять нет необходимости.
- `cfDebug` - включение / отключение отображения технической информации в логе {{< tag "RouterOS" >}}.

Рекомендую настраивать скрипт в редакторе с подсветкой синтаксиса, чтобы не ошибиться и не задеть какую-либо кавычку.

### Установка

После настройки скрипта, его нужно добавить в репозиторий скриптов {{< tag "RouterOS" >}}. Находится репозиторий в System / Scripts. При добавлении скрипта, необходимо выбрать политики `read`, `write`, `test`.

### Планировщик

Скрипт должен переодически запускаться для проверки и синхронизации IP адресов роутера и домена. В этом поможет планировщик {{< tag "RouterOS" >}}. Заходим в System / Scheduler и создаём задачу с политиками `read`, `write`, `test`. В поле **On Event** вписываем точное название скрипта, ранее добавленного в репозиторий {{< tag "RouterOS" >}}.

### Проверка

Проверить работу скрипта можно в репозитории по адресу System / Scripts. Выделив скрипт и нажав на кнопку {{< key "Run" >}}, смотрим изменился ли IP адрес у домена в панели управления {{< tag "CloudFlare" >}}.
